<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Midnight Plaza - Checkout</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        :root {
            --sunglow: #fdc921;
            --mustard: #fdd85d;
            --baby-powder: #fffdf7;
            --non-photo-blue: #99d6ea;
            --blue-gray: #6798c0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--baby-powder); color: #333; padding-bottom: 2rem; }
        .navbar { background: white; padding: 0.75rem 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .nav-left { display: flex; align-items: center; gap: 1rem; }
        .hamburger { display: flex; flex-direction: column; gap: 4px; cursor: pointer; padding: 0.5rem; }
        .hamburger span { width: 22px; height: 2.5px; background: var(--blue-gray); border-radius: 3px; transition: all 0.3s; }
        .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(7px, 7px); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }
        .logo { font-size: clamp(1.2rem, 4vw, 1.5rem); font-weight: bold; color: var(--sunglow); cursor: pointer; }
        .nav-items { display: none; position: fixed; top: 60px; left: 0; right: 0; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 0.5rem; flex-direction: column; gap: 0; z-index: 999; }
        .nav-items.active { display: flex; }
        .nav-item { cursor: pointer; padding: 0.9rem; border-radius: 8px; transition: background 0.3s; text-decoration: none; color: #333; font-weight: 500; font-size: 0.95rem; border-bottom: 1px solid #f0f0f0; }
        .nav-item:hover { background: var(--baby-powder); }
        .container { max-width: 900px; margin: 1rem auto; padding: 0 0.75rem; }
        .cart-container, .section-container { background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 1rem; }
        h2 { margin-bottom: 1rem; color: var(--sunglow); font-size: clamp(1.3rem, 4vw, 1.6rem); }
        .cart-item { display: flex; flex-direction: column; gap: 0.75rem; padding: 0.9rem; border-bottom: 1px solid #eee; }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 0.75rem; }
        .cart-item-details { flex: 1; min-width: 0; }
        .cart-item-name { font-size: clamp(0.95rem, 3vw, 1.05rem); font-weight: 600; margin-bottom: 0.2rem; word-wrap: break-word; }
        .cart-item-price { color: var(--blue-gray); font-weight: 600; font-size: clamp(0.85rem, 2.5vw, 0.95rem); }
        .cart-item-actions { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
        .cart-item-quantity { display: flex; align-items: center; gap: 0.6rem; }
        .quantity-btn { background: var(--sunglow); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .quantity-btn:active { transform: scale(0.9); }
        .quantity-display { font-size: 1rem; font-weight: 600; min-width: 25px; text-align: center; }
        .cart-item-total { font-size: clamp(1rem, 3vw, 1.15rem); font-weight: bold; color: #333; }
        .remove-btn { background: #dc3545; color: white; border: none; padding: 0.5rem 0.85rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s; }
        .remove-btn:active { transform: scale(0.95); }
        .cart-summary { margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #eee; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 0.75rem; font-size: clamp(0.9rem, 2.5vw, 1rem); }
        .summary-row.subtotal, .summary-row.delivery { color: #666; }
        .cart-total { display: flex; justify-content: space-between; font-size: clamp(1.3rem, 4vw, 1.5rem); font-weight: bold; color: var(--blue-gray); margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #eee; }
        .section-title { font-size: clamp(1.1rem, 3vw, 1.3rem); font-weight: 600; color: #333; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .address-display-card { border: 2px solid var(--non-photo-blue); border-radius: 10px; padding: 0.9rem; background: #f0f9ff; }
        .address-display-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .address-display-name { font-weight: 600; font-size: 1rem; color: #333; }
        .change-address-btn { background: var(--sunglow); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.3s; }
        .change-address-btn:active { transform: scale(0.95); }
        .address-display-phone { color: #666; font-size: 0.85rem; margin-bottom: 0.5rem; }
        .address-display-text { color: #555; line-height: 1.5; font-size: 0.9rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 600; color: #333; font-size: clamp(0.85rem, 2.5vw, 0.95rem); }
        .form-group input, .form-group textarea { width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: clamp(0.85rem, 2.5vw, 0.95rem); font-family: inherit; transition: border-color 0.3s; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--sunglow); }
        .form-group textarea { resize: vertical; min-height: 70px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        @media (max-width: 480px) { .form-row { grid-template-columns: 1fr; } }
        #map { width: 100%; height: 350px; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #e0e0e0; }
        .map-instruction { background: #fffbf0; border-left: 4px solid var(--sunglow); padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px; font-size: 0.85rem; color: #666; }
        .location-btn { background: var(--non-photo-blue); color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem; transition: all 0.3s; display: flex; align-items: center; gap: 0.5rem; }
        .location-btn:active { transform: scale(0.95); }
        .location-btn:disabled { background: #ccc; cursor: not-allowed; }
        .address-card { border: 2px solid #e0e0e0; border-radius: 10px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.3s; }
        .address-card:hover, .address-card.selected { border-color: var(--sunglow); background: #fffbf0; }
        .address-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.6rem; }
        .address-name { font-weight: 600; font-size: 1rem; color: #333; }
        .address-phone { color: #666; font-size: 0.85rem; margin-top: 0.2rem; }
        .address-details { color: #666; line-height: 1.5; font-size: 0.85rem; }
        .address-actions { display: flex; gap: 0.6rem; margin-top: 0.75rem; }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.8rem; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-delete:active { transform: scale(0.95); }
        .default-badge { background: var(--non-photo-blue); color: white; padding: 0.2rem 0.6rem; border-radius: 5px; font-size: 0.75rem; font-weight: 600; }
        .payment-option { display: flex; align-items: center; padding: 1rem; border: 2px solid #eee; border-radius: 10px; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.3s; }
        .payment-option:hover, .payment-option.selected { border-color: var(--sunglow); background: #fffbf0; }
        .payment-option input[type="radio"] { width: 18px; height: 18px; margin-right: 0.9rem; cursor: pointer; accent-color: var(--sunglow); }
        .payment-details { flex: 1; }
        .payment-title { font-size: clamp(0.95rem, 3vw, 1.05rem); font-weight: 600; margin-bottom: 0.2rem; }
        .payment-description { color: #666; font-size: clamp(0.8rem, 2vw, 0.85rem); }
        .btn { width: 100%; padding: 1rem; background: var(--blue-gray); color: white; border: none; border-radius: 10px; font-size: clamp(1rem, 3vw, 1.1rem); font-weight: 600; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
        .btn:active { transform: scale(0.98); box-shadow: inset 0 3px 8px rgba(0,0,0,0.2); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn.processing { background: #5989b3; pointer-events: none; }
        .btn.processing::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
        .btn-secondary { width: 100%; padding: 0.9rem; background: white; color: var(--sunglow); border: 2px solid var(--sunglow); border-radius: 10px; font-size: clamp(0.95rem, 3vw, 1.05rem); font-weight: 600; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
        .btn-secondary:active { transform: scale(0.98); background: var(--baby-powder); box-shadow: inset 0 3px 8px rgba(253,201,33,0.2); }
        .empty-cart { text-align: center; padding: 2.5rem 1rem; }
        .empty-cart-icon { font-size: clamp(3rem, 10vw, 4rem); margin-bottom: 0.75rem; }
        .empty-cart h3 { color: #666; margin-bottom: 0.75rem; font-size: clamp(1.1rem, 3vw, 1.3rem); }
        .continue-shopping { display: inline-flex; margin-top: 0.75rem; padding: 0.7rem 1.5rem; background: var(--sunglow); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s; align-items: center; }
        .continue-shopping:active { transform: scale(0.95); }
        .success-message, .error-message { padding: 0.9rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; font-weight: 600; display: none; font-size: 0.9rem; }
        .success-message { background: #d4edda; color: #155724; }
        .error-message { background: #f8d7da; color: #721c24; }
        .loader { display: none; text-align: center; padding: 0.75rem; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--sunglow); border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 1.5rem 2rem; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; display: none; text-align: center; min-width: 280px; max-width: 90%; animation: toastSlideIn 0.3s ease-out; }
        .toast.show { display: block; }
        .toast-success { border-left: 5px solid var(--non-photo-blue); }
        .toast-error { border-left: 5px solid #dc3545; }
        .toast-icon { font-size: 3rem; margin-bottom: 0.75rem; }
        .toast-message { font-size: 1.1rem; font-weight: 600; color: #333; margin-bottom: 0.5rem; }
        .toast-submessage { font-size: 0.9rem; color: #666; }
        @keyframes toastSlideIn { from { transform: translate(-50%, -60%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
        .toast-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 9999; display: none; }
        .toast-overlay.show { display: block; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; animation: fadeIn 0.3s; }
        .modal-overlay.active { display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .modal-content { background: white; border-radius: 12px; padding: 1.25rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
        .modal-title { font-size: 1.3rem; font-weight: 600; color: #333; }
        .close-modal { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #666; line-height: 1; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
        .coord-display { background: #f0f9ff; border: 2px solid var(--non-photo-blue); border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem; font-size: 0.85rem; color: #666; text-align: center; }
        .inline-addresses { margin-top: 0.75rem; }
        @media (min-width: 768px) {
            .cart-item { flex-direction: row; align-items: center; }
            .quantity-btn:hover { background: var(--mustard); transform: scale(1.1); }
            .remove-btn:hover { background: #c82333; }
            .btn:hover:not(:disabled) { background: #5989b3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(103, 152, 192, 0.4); }
            .btn:active:not(:disabled) { transform: translateY(0); box-shadow: inset 0 3px 8px rgba(0,0,0,0.2); }
            .btn-secondary:hover { background: var(--baby-powder); border-color: var(--mustard); color: var(--mustard); transform: translateY(-2px); }
            .btn-secondary:active { transform: translateY(0); }
            .hamburger { display: none; }
            .nav-items { display: flex !important; position: static; flex-direction: row; padding: 0; box-shadow: none; gap: 0.75rem; }
            .nav-item { border-bottom: none; padding: 0.4rem 0.6rem; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="nav-left">
            <div class="hamburger" onclick="toggleMenu()">
                <span></span><span></span><span></span>
            </div>
            <div class="logo" onclick="window.location.href='home.html'">🍔 Midnight Plaza</div>
        </div>
    </div>

    <div class="nav-items" id="navMenu">
        <a href="home.html" class="nav-item">🏠 Home</a>
        <a href="orders.html" class="nav-item">📦 Orders</a>
        <a href="checkout.html" class="nav-item">🛒 Cart</a>
        <span class="nav-item" onclick="logout()">🚪 Logout</span>
    </div>

    <div class="container">
        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>

        <div class="toast-overlay" id="toastOverlay"></div>
        <div class="toast" id="toast">
            <div class="toast-icon" id="toastIcon"></div>
            <div class="toast-message" id="toastMessage"></div>
            <div class="toast-submessage" id="toastSubMessage"></div>
        </div>

        <div class="cart-container">
            <h2>Your Cart</h2>
            <div id="cartContent"></div>
        </div>

        <div id="checkoutSections" style="display: none;">
            <div class="section-container">
                <div class="section-title">📍 Delivery Address</div>
                <div id="addressDisplayArea"></div>

                <!-- Inline list of saved addresses so user can select without opening modal -->
                <div class="inline-addresses" id="inlineAddressesList"></div>
            </div>

            <div class="section-container">
                <div class="section-title">💳 Payment Method</div>
                <div class="payment-option" onclick="selectPayment('cod')" id="paymentCodOption">
                    <input type="radio" name="payment" id="cod" value="cod">
                    <div class="payment-details">
                        <div class="payment-title">💵 Cash on Delivery</div>
                        <div class="payment-description">Pay when order arrives</div>
                    </div>
                </div>
                <div class="payment-option" onclick="selectPayment('online')" id="paymentOnlineOption">
                    <input type="radio" name="payment" id="online" value="online">
                    <div class="payment-details">
                        <div class="payment-title">💳 Online Payment</div>
                        <div class="payment-description">Razorpay (UPI, Card, Net Banking)</div>
                    </div>
                </div>
                <div class="loader" id="loader">
                    <div class="spinner"></div>
                    <p style="margin-top: 0.75rem; color: #666; font-size: 0.9rem;">Processing...</p>
                </div>
                <button class="btn" id="placeOrderBtn" onclick="handlePlaceOrder()" disabled>Select Payment Method</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addressModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Select Address</div>
                <button class="close-modal" onclick="closeAddressModal()">&times;</button>
            </div>

            <div id="savedAddressesList" style="display: none;">
                <div id="addressCards"></div>
                <button type="button" class="btn-secondary" onclick="showAddressForm()" style="margin-top: 0.75rem;">+ Add New Address</button>
            </div>

            <div id="addressFormContainer">
                <div class="map-instruction">
                    📍 Drag the red marker to your exact delivery location. Your location will be auto-detected first.
                </div>
                <button type="button" class="location-btn" id="locationBtn" onclick="getLocation()">📍 Detecting Location...</button>
                <div id="map"></div>
                <div class="coord-display" id="coordDisplay">
                    📌 Selected Location: <strong id="currentCoords">Detecting...</strong>
                </div>
                <div style="text-align: center; margin-top: 0.5rem; color: #666; font-size: 0.85rem;">
                    💡 Can't detect? <span style="color: var(--sunglow); font-weight: 600; cursor: pointer;" onclick="showLocationHelp()">Click here for help</span>
                </div>
                <form id="addressForm" onsubmit="event.preventDefault();">
                    <div class="form-group">
                        <label for="fullName">Full Name *</label>
                        <input type="text" id="fullName" required placeholder="Your full name">
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" required placeholder="10 digit number" pattern="[0-9]{10}">
                    </div>
                    <div class="form-group">
                        <label for="address">Address *</label>
                        <textarea id="address" required placeholder="House No., Street, Area" rows="2"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City *</label>
                            <input type="text" id="city" required placeholder="City">
                        </div>
                        <div class="form-group">
                            <label for="pincode">Pincode *</label>
                            <input type="text" id="pincode" required placeholder="6 digits" pattern="[0-9]{6}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="landmark">Landmark</label>
                        <input type="text" id="landmark" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;">
                            <input type="checkbox" id="saveAddress" checked style="width: auto;">
                            <span>Save for future orders</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <button type="button" class="btn" id="deliverHereBtn" onclick="saveAndSelectAddress()" style="flex: 1; min-width: 150px;">
                            <span id="deliverHereBtnText">📍 Deliver Here</span>
                        </button>
                        <button type="button" class="btn-secondary" onclick="showSavedAddresses()" id="backToSavedBtn" style="display: none; flex: 1; min-width: 150px;">← Back</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getDatabase, ref, push, set, get, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        const app = initializeApp({
            apiKey: "AIzaSyCTB7d1-tjzU3DG0tvmkh1lWiZcmba10XI",
            authDomain: "hungrybites-c7930.firebaseapp.com",
            projectId: "hungrybites-c7930",
            storageBucket: "hungrybites-c7930.firebasestorage.app",
            messagingSenderId: "346758544945",
            appId: "1:346758544945:web:4bcad30016540d18e79f10",
            measurementId: "G-B5GP5SYMRC",
            databaseURL: "https://hungrybites-c7930-default-rtdb.firebaseio.com"
        });

        const auth = getAuth(app), db = getDatabase(app);
        let cart = [], currentUser = null, selectedPayment = null, deliveryAddress = null;
        let savedAddresses = [], selectedAddressId = null, map, marker;
        let finalPinLocation = null;
        let initialLocationDetected = false;
        const RAZORPAY_KEY = 'rzp_test_your_key_here';

        /********** Utility: update coords display **********/
        function updateCoordinatesDisplay() {
            if (finalPinLocation) {
                const el = document.getElementById('currentCoords');
                if (el) el.textContent = `${finalPinLocation.lat.toFixed(6)}, ${finalPinLocation.lng.toFixed(6)}`;
            }
        }

        /********** Location detection & Google Maps init (unchanged) **********/
        window.getLocation = function() {
            const btn = document.getElementById('locationBtn');
            if (!btn) return;
            btn.disabled = true;
            btn.innerHTML = '📍 Detecting...';
            let locationFound = false;

            const onSuccess = (lat, lng, source) => {
                if (locationFound) return;
                locationFound = true;
                const latLng = new google.maps.LatLng(lat, lng);
                map.setCenter(latLng);
                map.setZoom(15);
                setMarkerPosition(latLng, true);
                initialLocationDetected = true;
                btn.innerHTML = '✅ Located';
                btn.disabled = false;
                showSuccess('Location detected - drag pin if needed');
            };

            const onError = (msg) => {
                if (locationFound) return;
                btn.innerHTML = '📍 Use My Location';
                btn.disabled = false;
                showError(msg);
                const defaultLatLng = new google.maps.LatLng(22.9734, 78.6569);
                setMarkerPosition(defaultLatLng, false);
                const el = document.getElementById('currentCoords');
                if (el) el.textContent = 'Default location - please drag pin';
            };

            if (window.Android && typeof window.Android.getCurrentLocation === 'function') {
                try {
                    const loc = window.Android.getCurrentLocation();
                    if (loc) {
                        const parsed = typeof loc === 'string' ? JSON.parse(loc) : loc;
                        if (parsed && parsed.lat && parsed.lng) {
                            return onSuccess(parsed.lat, parsed.lng, 'Android Interface');
                        }
                    }
                } catch(e) { console.log('Android interface failed:', e); }
            }

            if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.getCurrentLocation) {
                try {
                    window.webkit.messageHandlers.getCurrentLocation.postMessage({});
                    window.setLocation = (lat, lng) => onSuccess(lat, lng, 'iOS WebKit');
                    setTimeout(() => { if (!locationFound) tryStandardGeo(); }, 2000);
                    return;
                } catch(e) { console.log('iOS WebKit failed:', e); }
            }

            const tryStandardGeo = () => {
                if (!navigator.geolocation) { return onError('Geolocation not supported - drag marker to set location'); }

                const optsHigh = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };

                navigator.geolocation.getCurrentPosition(
                    pos => onSuccess(pos.coords.latitude, pos.coords.longitude, 'HTML5 High Accuracy'),
                    err1 => {
                        const optsLow = { enableHighAccuracy: false, timeout: 8000, maximumAge: 5000 };
                        navigator.geolocation.getCurrentPosition(
                            pos => onSuccess(pos.coords.latitude, pos.coords.longitude, 'HTML5 Low Accuracy'),
                            err2 => {
                                const msgs = { 1: 'Location permission denied - enable in app settings', 2: 'Location unavailable - drag marker to your location', 3: 'Location timeout - drag marker to your location' };
                                onError(msgs[err2.code] || 'Drag marker to set your location');
                            },
                            optsLow
                        );
                    },
                    optsHigh
                );
            };

            const tryIPLocation = () => {
                setTimeout(() => {
                    if (!locationFound) {
                        fetch('https://ipapi.co/json/').then(r => r.json()).then(data => {
                            if (data.latitude && data.longitude) onSuccess(data.latitude, data.longitude, 'IP Location (approximate)');
                        }).catch(() => onError('Drag marker to set your location'));
                    }
                }, 12000);
            };

            tryStandardGeo();
            tryIPLocation();
        };

        window.initMap = function() {
            const defaultLocation = { lat: 22.9734, lng: 78.6569 };
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultLocation,
                zoom: 5,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            marker = new google.maps.Marker({
                position: defaultLocation,
                map: map,
                draggable: true,
                animation: google.maps.Animation.DROP
            });

            finalPinLocation = defaultLocation;
            updateCoordinatesDisplay();

            map.addListener('click', e => setMarkerPosition(e.latLng, false));
            marker.addListener('dragend', e => { setMarkerPosition(e.latLng, false); showSuccess('Pin location updated'); });
            marker.addListener('drag', e => { finalPinLocation = { lat: e.latLng.lat(), lng: e.latLng.lng() }; updateCoordinatesDisplay(); });

            setTimeout(() => window.getLocation(), 500);
        };

        function setMarkerPosition(latLng, isInitialDetection = false) {
            finalPinLocation = { lat: latLng.lat(), lng: latLng.lng() };
            if (marker) marker.setPosition(latLng);
            if (map) map.panTo(latLng);
            updateCoordinatesDisplay();

            new google.maps.Geocoder().geocode({ location: latLng }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const c = results[0].address_components;
                    let city = '', pin = '', addr = '', area = '', state = '';
                    c.forEach(comp => {
                        const t = comp.types;
                        if (t.includes('locality') || t.includes('administrative_area_level_2')) city = comp.long_name;
                        if (t.includes('postal_code')) pin = comp.long_name;
                        if (t.includes('sublocality') || t.includes('neighborhood')) area = comp.long_name;
                        if (t.includes('route')) addr = comp.long_name;
                        if (t.includes('administrative_area_level_1')) state = comp.long_name;
                    });
                    if (city) document.getElementById('city').value = city;
                    if (pin) document.getElementById('pincode').value = pin;
                    if (addr || area) document.getElementById('address').value = [addr, area].filter(Boolean).join(', ');
                    if (state) document.getElementById('landmark').value = `Near ${area || city}, ${state}`;
                    if (!isInitialDetection) showSuccess('Address updated from pin location');
                }
            });
        }

        window.showLocationHelp = function() {
            alert('Location Detection Help:\n\n1. Allow location permission when prompted\n2. DRAG the red marker to your EXACT delivery location\n3. You can also tap anywhere on the map\n4. The coordinates shown below the map are what will be saved\n5. Make sure to position the pin at your exact address');
        };

        /********** Auth & initial load **********/
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                loadGoogleMaps();
                loadCart();
                loadSavedAddresses();
                // pre-select COD as requested
                selectPayment('cod');
            } else {
                window.location.href = 'index.html';
            }
        });

        function loadGoogleMaps() {
            if (window.google?.maps) { window.initMap(); return; }
            const s = document.createElement('script');
            s.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc&callback=initMap';
            s.async = true;
            s.defer = true;
            document.head.appendChild(s);
        }

        function loadCart() {
            try {
                const savedCart = localStorage.getItem('midnightPlazaCart');
                if (savedCart) cart = JSON.parse(savedCart);
            } catch (error) { console.error('Error loading cart from localStorage:', error); cart = []; }
            renderCart();
        }

        function renderCart() {
            const content = document.getElementById('cartContent');
            const sections = document.getElementById('checkoutSections');
            if (!cart.length) {
                content.innerHTML = `
                    <div class="empty-cart">
                        <div class="empty-cart-icon">🛒</div>
                        <h3>Your cart is empty</h3>
                        <p>Add delicious items to get started!</p>
                        <a href="home.html" class="continue-shopping">Browse Menu</a>
                    </div>`;
                sections.style.display = 'none';
                return;
            }
            sections.style.display = 'block';
            const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
            const delivery = 40, total = subtotal + delivery;

            content.innerHTML = cart.map((item, i) => `
                <div class="cart-item">
                    <div class="cart-item-header">
                        <div class="cart-item-details">
                            <div class="cart-item-name">${item.emoji || '🍔'} ${item.name}</div>
                            <div class="cart-item-price">₹${item.price}</div>
                        </div>
                        <div class="cart-item-total">₹${item.price * item.quantity}</div>
                    </div>
                    <div class="cart-item-actions">
                        <div class="cart-item-quantity">
                            <button class="quantity-btn" onclick="updateQuantity(${i}, -1)">-</button>
                            <div class="quantity-display">${item.quantity}</div>
                            <button class="quantity-btn" onclick="updateQuantity(${i}, 1)">+</button>
                        </div>
                        <button class="remove-btn" onclick="removeItem(${i})">Remove</button>
                    </div>
                </div>
            `).join('') + `
                <div class="cart-summary">
                    <div class="summary-row subtotal"><span>Subtotal</span><span>₹${subtotal}</span></div>
                    <div class="summary-row delivery"><span>Delivery Fee</span><span>₹${delivery}</span></div>
                    <div class="cart-total"><span>Total</span><span>₹${total}</span></div>
                </div>`;
        }

        window.updateQuantity = (i, change) => {
            cart[i].quantity += change;
            if (cart[i].quantity <= 0) cart.splice(i, 1);
            saveCart();
            renderCart();
        };

        window.removeItem = i => {
            if (confirm('Remove this item?')) {
                cart.splice(i, 1);
                saveCart();
                renderCart();
            }
        };

        function saveCart() {
            try { localStorage.setItem('midnightPlazaCart', JSON.stringify(cart)); } catch (error) { console.error('Error saving cart to localStorage:', error); }
        }

        /********** Saved addresses loading and rendering **********/
        async function loadSavedAddresses() {
            if (!currentUser) return;
            try {
                const snap = await get(ref(db, `users/${currentUser.uid}/addresses`));
                savedAddresses = [];
                if (snap.exists()) {
                    snap.forEach(child => savedAddresses.push({ id: child.key, ...child.val() }));
                }
                // ensure consistent ordering (by createdAt if present)
                savedAddresses.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

                // Set selected address (prefer previously selected, else first in list)
                if (savedAddresses.length) {
                    if (!selectedAddressId) {
                        selectedAddressId = savedAddresses[0].id;
                    }
                    deliveryAddress = savedAddresses.find(a => a.id === selectedAddressId) || savedAddresses[0];
                } else {
                    deliveryAddress = null;
                    selectedAddressId = null;
                }

                renderAddressDisplay();
                renderInlineAddresses(); // show inline list on checkout page
            } catch (e) {
                console.error('Load addresses error:', e);
                // fallback: show modal to add address
                deliveryAddress = null;
                selectedAddressId = null;
                renderAddressDisplay();
            }
        }

        function renderAddressDisplay() {
            const area = document.getElementById('addressDisplayArea');
            if (!deliveryAddress) {
                area.innerHTML = '<button class="btn-secondary" onclick="showAddressModal()">+ Add Delivery Address</button>';
                return;
            }

            const serviceableIndicator = deliveryAddress.serviceable === false ?
                '<div style="margin-top:0.5rem;padding:0.5rem;background:#fff3cd;border-left:4px solid #ffc107;border-radius:4px;font-size:0.8rem;color:#856404;">⚠️ This address is out of service area</div>' : '';

            const coords = deliveryAddress.coordinates ?
                `<div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid var(--non-photo-blue);font-size:0.8rem;color:#666;">📍 ${deliveryAddress.coordinates.lat.toFixed(6)}, ${deliveryAddress.coordinates.lng.toFixed(6)}</div>` : '';

            area.innerHTML = `
                <div class="address-display-card">
                    <div class="address-display-header">
                        <div>
                            <div class="address-display-name">${deliveryAddress.fullName}</div>
                            <div class="address-display-phone">${deliveryAddress.phone}</div>
                        </div>
                        <button class="change-address-btn" onclick="showAddressModal()">Change</button>
                    </div>
                    <div class="address-display-text">
                        ${deliveryAddress.streetAddress || deliveryAddress.address}<br>
                        ${deliveryAddress.city}, ${deliveryAddress.pincode}
                        ${deliveryAddress.landmark ? `<br>Landmark: ${deliveryAddress.landmark}` : ''}
                    </div>${coords}${serviceableIndicator}
                </div>`;
        }

        // Render inline list of saved addresses on checkout page (so user can pick without opening modal)
        function renderInlineAddresses() {
            const container = document.getElementById('inlineAddressesList');
            if (!container) return;
            if (!savedAddresses.length) {
                container.innerHTML = `<div style="margin-top:0.5rem;"><small style="color:#666;">No saved addresses. <button class="btn-secondary" onclick="showAddressModal()" style="display:inline-block;margin-top:6px;">Add Address</button></small></div>`;
                return;
            }

            container.innerHTML = savedAddresses.map((a, i) => {
                const coords = a.coordinates ? `<br><small style="color:#999;">📍 ${a.coordinates.lat.toFixed(4)}, ${a.coordinates.lng.toFixed(4)}</small>` : '';
                const serviceableWarning = a.serviceable === false ? '<br><small style="color:#dc3545;">⚠️ Out of service area</small>' : '';
                const selectedClass = selectedAddressId === a.id ? 'selected' : '';
                const defaultBadge = i === 0 ? '<span class="default-badge">Default</span>' : '';
                return `
                    <div class="address-card ${selectedClass}" data-addr-id="${a.id}">
                        <div class="address-card-header">
                            <div>
                                <div class="address-name">${a.fullName}</div>
                                <div class="address-phone">${a.phone}</div>
                            </div>
                            ${defaultBadge}
                        </div>
                        <div class="address-details">
                            ${a.streetAddress || a.address}<br>
                            ${a.city}, ${a.pincode}
                            ${a.landmark ? `<br>Landmark: ${a.landmark}` : ''}${coords}${serviceableWarning}
                        </div>
                    </div>
                `;
            }).join('');

            // Attach click listeners (avoid inline event hassles)
            container.querySelectorAll('.address-card').forEach(card => {
                card.onclick = () => {
                    const id = card.getAttribute('data-addr-id');
                    selectSavedAddress(id, false, false); // don't close modal (we're inline)
                };
            });
        }

        // Render addresses inside modal (existing UX)
        function renderSavedAddresses() {
            const list = document.getElementById('savedAddressesList');
            const form = document.getElementById('addressFormContainer');
            const cards = document.getElementById('addressCards');

            if (!savedAddresses.length) {
                list.style.display = 'none';
                form.style.display = 'block';
                document.getElementById('backToSavedBtn').style.display = 'none';
                return;
            }

            list.style.display = 'block';
            form.style.display = 'none';
            cards.innerHTML = savedAddresses.map((a, i) => {
                const coords = a.coordinates ? `<br><small style="color:#999;">📍 ${a.coordinates.lat.toFixed(4)}, ${a.coordinates.lng.toFixed(4)}</small>` : '';
                const serviceableWarning = a.serviceable === false ? '<br><small style="color:#dc3545;">⚠️ Out of service area</small>' : '';
                return `
                    <div class="address-card ${selectedAddressId === a.id ? 'selected' : ''}" onclick="selectSavedAddress('${a.id}', false, true)" style="${a.serviceable === false ? 'opacity: 0.85; border-color: #ffc107;' : ''}">
                        <div class="address-card-header">
                            <div>
                                <div class="address-name">${a.fullName}</div>
                                <div class="address-phone">${a.phone}</div>
                            </div>
                            ${i === 0 ? '<span class="default-badge">Default</span>' : ''}
                        </div>
                        <div class="address-details">
                            ${a.streetAddress || a.address}<br>
                            ${a.city}, ${a.pincode}
                            ${a.landmark ? `<br>Landmark: ${a.landmark}` : ''}${coords}${serviceableWarning}
                        </div>
                        <div class="address-actions">
                            <button class="btn-small btn-delete" onclick="event.stopPropagation(); deleteAddress('${a.id}')">Delete</button>
                        </div>
                    </div>`;
            }).join('');
        }

        /**
         * Select an address by id.
         * @param {string} id
         * @param {boolean} auto - was it automatic on load? if true we avoid closing modal
         * @param {boolean} closeModal - whether to close modal after selection (for modal use)
         */
        window.selectSavedAddress = (id, auto = false, closeModal = false) => {
            selectedAddressId = id;
            deliveryAddress = savedAddresses.find(a => a.id === id) || null;
            // update displays
            renderAddressDisplay();
            renderInlineAddresses();
            renderSavedAddresses(); // update modal selection visuals if open

            // close modal if requested (modal selection)
            if (!auto && closeModal) {
                setTimeout(() => closeAddressModal(), 250);
            }
        };

        window.deleteAddress = async id => {
            if (!confirm('Delete this address?')) return;
            try {
                await remove(ref(db, `users/${currentUser.uid}/addresses/${id}`));
                savedAddresses = savedAddresses.filter(a => a.id !== id);
                if (selectedAddressId === id) {
                    selectedAddressId = null;
                    deliveryAddress = null;
                    if (savedAddresses.length) {
                        selectedAddressId = savedAddresses[0].id;
                        deliveryAddress = savedAddresses[0];
                    }
                }
                renderSavedAddresses();
                renderInlineAddresses();
                renderAddressDisplay();
                showSuccess('Address deleted');
            } catch (e) {
                console.error('Delete error:', e);
                showError('Failed to delete');
            }
        };

        window.showAddressModal = () => {
            document.getElementById('addressModal').classList.add('active');
            renderSavedAddresses();
            setTimeout(() => {
                if (map) {
                    google.maps.event.trigger(map, 'resize');
                    if (document.getElementById('addressFormContainer').style.display !== 'none') {
                        const defaultLocation = { lat: 22.9734, lng: 78.6569 };
                        finalPinLocation = defaultLocation;
                        map.setCenter(defaultLocation);
                        map.setZoom(5);
                        marker.setPosition(defaultLocation);
                        updateCoordinatesDisplay();
                        initialLocationDetected = false;
                        window.getLocation();
                    }
                }
            }, 300);
        };

        window.closeAddressModal = () => document.getElementById('addressModal').classList.remove('active');

        window.showAddressForm = () => {
            document.getElementById('savedAddressesList').style.display = 'none';
            document.getElementById('addressFormContainer').style.display = 'block';
            document.getElementById('backToSavedBtn').style.display = savedAddresses.length ? 'block' : 'none';
            document.getElementById('addressForm').reset();
            document.getElementById('saveAddress').checked = true;
            initialLocationDetected = false;
            const defaultLocation = { lat: 22.9734, lng: 78.6569 };
            finalPinLocation = defaultLocation;

            setTimeout(() => {
                if (map) {
                    google.maps.event.trigger(map, 'resize');
                    map.setCenter(defaultLocation);
                    map.setZoom(5);
                    marker.setPosition(defaultLocation);
                    updateCoordinatesDisplay();
                    window.getLocation();
                }
            }, 100);
        };

        window.showSavedAddresses = () => {
            if (savedAddresses.length) {
                document.getElementById('savedAddressesList').style.display = 'block';
                document.getElementById('addressFormContainer').style.display = 'none';
            }
        };

        /********** save new address logic (unchanged) **********/
        window.saveAndSelectAddress = async () => {
            const name = document.getElementById('fullName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const addr = document.getElementById('address').value.trim();
            const city = document.getElementById('city').value.trim();
            const pin = document.getElementById('pincode').value.trim();
            const landmark = document.getElementById('landmark').value.trim();
            const save = document.getElementById('saveAddress').checked;

            if (!name || !phone || !addr || !city || !pin) return showError('Fill all required fields');
            if (!/^[0-9]{10}$/.test(phone)) return showError('Enter valid 10-digit phone');
            if (!/^[0-9]{6}$/.test(pin)) return showError('Enter valid 6-digit pincode');
            if (!finalPinLocation) return showError('Please set your location on the map');

            const btn = document.getElementById('deliverHereBtn');
            const btnText = document.getElementById('deliverHereBtnText');
            btn.disabled = true;
            btn.classList.add('processing');
            btnText.textContent = '⏳ Checking...';

            try {
                const pincodeRef = ref(db, `servicepincodes/${pin}`);
                const pincodeSnap = await get(pincodeRef);

                if (!pincodeSnap.exists() || pincodeSnap.val() !== true) {
                    deliveryAddress = { fullName: name, phone, streetAddress: addr, city, pincode: pin, landmark, coordinates: finalPinLocation };

                    if (save && currentUser) {
                        try {
                            const newRef = push(ref(db, `users/${currentUser.uid}/addresses`));
                            await set(newRef, { ...deliveryAddress, createdAt: Date.now(), serviceable: false });
                            savedAddresses.unshift({ id: newRef.key, ...deliveryAddress, serviceable: false });
                        } catch (e) { console.error('Save error:', e); }
                    }

                    btn.disabled = false;
                    btn.classList.remove('processing');
                    btnText.textContent = '📍 Deliver Here';
                    showToast('error', '⚠️ Out of Service Area', 'Pincode is out of service area. Please try another address.');

                    setTimeout(() => {
                        const toast = document.getElementById('toast');
                        const overlay = document.getElementById('toastOverlay');
                        toast.classList.remove('show');
                        overlay.classList.remove('show');
                    }, 5000);

                    renderInlineAddresses();
                    renderSavedAddresses();
                    renderAddressDisplay();
                    return;
                }

                btnText.textContent = '⏳ Saving...';
                deliveryAddress = { fullName: name, phone, streetAddress: addr, city, pincode: pin, landmark, coordinates: finalPinLocation, serviceable: true };

                if (save && currentUser) {
                    try {
                        const newRef = push(ref(db, `users/${currentUser.uid}/addresses`));
                        await set(newRef, { ...deliveryAddress, createdAt: Date.now() });
                        savedAddresses.unshift({ id: newRef.key, ...deliveryAddress });
                        selectedAddressId = newRef.key;

                        btnText.textContent = '✅ Saved!';
                        btn.style.background = '#60b246';

                        setTimeout(() => {
                            showSuccess('Address saved successfully');
                            renderAddressDisplay();
                            renderInlineAddresses();
                            renderSavedAddresses();
                            closeAddressModal();
                            btn.disabled = false;
                            btn.classList.remove('processing');
                            btn.style.background = '';
                            btnText.textContent = '📍 Deliver Here';
                        }, 800);
                    } catch (e) {
                        console.error('Save error:', e);
                        showError('Failed to save address');
                        btn.disabled = false;
                        btn.classList.remove('processing');
                        btnText.textContent = '📍 Deliver Here';
                    }
                } else {
                    btnText.textContent = '✅ Selected!';
                    btn.style.background = '#60b246';

                    setTimeout(() => {
                        renderAddressDisplay();
                        renderInlineAddresses();
                        closeAddressModal();
                        btn.disabled = false;
                        btn.classList.remove('processing');
                        btn.style.background = '';
                        btnText.textContent = '📍 Deliver Here';
                    }, 600);
                }
            } catch (error) {
                console.error('Error checking pincode:', error);
                showError('Failed to verify pincode. Please try again.');
                btn.disabled = false;
                btn.classList.remove('processing');
                btnText.textContent = '📍 Deliver Here';
            }
        };

        /********** Payment selection and order placement **********/
        window.selectPayment = method => {
            selectedPayment = method;
            document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
            const radio = document.getElementById(method);
            if (radio) radio.checked = true;
            const optionEl = method === 'cod' ? document.getElementById('paymentCodOption') : document.getElementById('paymentOnlineOption');
            if (optionEl) optionEl.classList.add('selected');
            const btn = document.getElementById('placeOrderBtn');
            btn.disabled = false;
            btn.textContent = method === 'cod' ? 'Place Order (COD)' : 'Pay Now';
        };

        window.handlePlaceOrder = async () => {
            if (!deliveryAddress) { showError('Add delivery address'); showAddressModal(); return; }
            if (!selectedPayment) return showError('Select payment method');

            if (deliveryAddress.serviceable === false || !deliveryAddress.serviceable) {
                return showToast('error', '⚠️ Out of Service Area', 'Selected address is out of service area. Please choose another address.');
            }

            const snap = await get(ref(db, 'storeStatus'));
            if (!snap.exists() || !snap.val().isOpen) {
                return showToast('error', '🔒 Store Closed', 'Not taking orders now. Try again later.');
            }

            selectedPayment === 'cod' ? await placeOrder('cod', null) : await initiateRazorpay();
        };

        async function initiateRazorpay() {
            const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
            const total = subtotal + 40;

            new Razorpay({
                key: RAZORPAY_KEY,
                amount: total * 100,
                currency: 'INR',
                name: 'Midnight Plaza',
                description: 'Food Order',
                handler: async res => await placeOrder('online', res.razorpay_payment_id),
                prefill: { name: deliveryAddress.fullName, email: currentUser?.email || '', contact: deliveryAddress.phone },
                theme: { color: '#fdc921' },
                modal: { ondismiss: () => showError('Payment cancelled') }
            }).open();
        }

        async function placeOrder(method, paymentId) {
            if (!currentUser || !cart.length) return showError('Unable to place order');

            const loader = document.getElementById('loader');
            const btn = document.getElementById('placeOrderBtn');
            loader.style.display = 'block';
            btn.disabled = true;

            const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
            const total = subtotal + 40;

            try {
                await push(ref(db, 'orders'), {
                    userId: currentUser.uid,
                    userEmail: currentUser.email || '',
                    items: cart,
                    subtotal, deliveryFee: 40, total,
                    deliveryAddress: {
                        address: deliveryAddress.streetAddress || deliveryAddress.address,
                        fullName: deliveryAddress.fullName,
                        phone: deliveryAddress.phone,
                        city: deliveryAddress.city,
                        pincode: deliveryAddress.pincode,
                        landmark: deliveryAddress.landmark || '',
                        coordinates: deliveryAddress.coordinates
                    },
                    paymentMethod: method,
                    paymentStatus: method === 'online' ? 'paid' : 'pending',
                    ...(paymentId && { paymentId }),
                    status: 'pending',
                    createdAt: Date.now()
                });

                showToast('success', '✅ Order Successful!', 'Redirecting to My Orders...');
                localStorage.removeItem('midnightPlazaCart');
                cart = [];
                setTimeout(() => window.location.href = 'orders.html', 2500);
            } catch (e) {
                console.error('Order error:', e);
                showError('Failed to place order');
                loader.style.display = 'none';
                btn.disabled = false;
            }
        }

        /********** UI helpers **********/
        function showToast(type, msg, sub) {
            const toast = document.getElementById('toast');
            const overlay = document.getElementById('toastOverlay');
            toast.className = `toast show toast-${type}`;
            overlay.classList.add('show');
            document.getElementById('toastIcon').textContent = type === 'success' ? '✅' : '❌';
            document.getElementById('toastMessage').textContent = msg;
            document.getElementById('toastSubMessage').textContent = sub || '';
            if (type === 'error') setTimeout(() => { toast.classList.remove('show'); overlay.classList.remove('show'); }, 3000);
        }

        function showSuccess(msg) {
            const el = document.getElementById('successMessage');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        function showError(msg) {
            const el = document.getElementById('errorMessage');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        window.toggleMenu = () => {
            document.querySelector('.hamburger').classList.toggle('active');
            document.getElementById('navMenu').classList.toggle('active');
        };

        document.addEventListener('click', e => {
            const navLeft = document.querySelector('.nav-left');
            const navMenu = document.getElementById('navMenu');
            const modal = document.getElementById('addressModal');
            if (!navLeft.contains(e.target) && !navMenu.contains(e.target)) {
                document.querySelector('.hamburger').classList.remove('active');
                navMenu.classList.remove('active');
            }
            if (e.target === modal) closeAddressModal();
        });

        window.logout = async () => {
            if (confirm('Logout?')) {
                try {
                    await signOut(auth);
                    localStorage.removeItem('midnightPlazaCart');
                    window.location.href = 'index.html';
                } catch (e) {
                    console.error('Logout error:', e);
                }
            }
        };

        // ensure COD is selected on load (default)
        window.addEventListener('load', () => {
            // if auth already set will re-invoke selectPayment in onAuthStateChanged,
            // but this sets UI early for clarity.
            selectPayment('cod');
        });
    </script>
</body>
</html>
